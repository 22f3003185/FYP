<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power System | Interactive Analysis</title>
    <style>
        :root {
            --bg-color: #1e1e24;
            --panel-bg: #2b2b36;
            --accent-blue: #00ffff;
            --accent-green: #00ff00d4;
            --accent-red: #ff0000;
            --text-main: #ffffff;
            --text-muted: #8d99ae;
            --line-normal: #a8dadc;
            --bus-color: #ffff00;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 350px;
            background-color: var(--panel-bg);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
        }

        h1 { font-size: 1.4rem; margin: 0; color: var(--accent-blue); }
        h2 { font-size: 1.1rem; border-bottom: 1px solid var(--text-muted); padding-bottom: 5px; margin-top: 0; }
        
        .status-card {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--text-muted);
        }

        .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .data-label { color: var(--text-muted); }
        .data-val { font-weight: bold; font-family: 'Courier New', monospace; }

        .control-group { margin-top: auto; }
        select {
            width: 100%;
            padding: 10px;
            background: var(--bg-color);
            color: var(--text-main);
            border: 1px solid var(--text-muted);
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-red);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { filter: brightness(1.1); }
        button:disabled { background-color: var(--text-muted); cursor: not-allowed; }
        
        button.btn-clear { background-color: var(--accent-green); }

        #diagram-container {
            flex-grow: 1;
            position: relative;
            overflow: auto; 
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: radial-gradient(var(--panel-bg) 1px, transparent 1px);
            background-size: 20px 20px; 
        }

        svg { width: 90%; height: 90%; max-width: 1200px; }

        .line-path { stroke: var(--line-normal); stroke-width: 3; fill: none; transition: stroke 0.3s, stroke-width 0.3s; cursor: pointer; }
        .line-path:hover, .line-path.active { stroke: var(--accent-blue); stroke-width: 5; }
        
        .bus-bar { stroke: var(--bus-color); stroke-width: 6; cursor: pointer; transition: stroke 0.2s; }
        .bus-bar:hover, .bus-bar.active { stroke: #fff; }

        .component-shape { fill: var(--bg-color); stroke: var(--text-main); stroke-width: 2; }
        .label-text { fill: var(--text-muted); font-size: 12px; font-family: sans-serif; pointer-events: none; }

        .fault-flash { animation: flash 0.5s infinite; stroke: var(--accent-red) !important; }
        @keyframes flash { 0% { stroke-opacity: 1; } 50% { stroke-opacity: 0.2; } 100% { stroke-opacity: 1; } }

        .legend { position: absolute; bottom: 20px; right: 20px; background: var(--panel-bg); padding: 10px; border-radius: 5px; font-size: 0.8rem; color: var(--text-muted); }
        .legend span { display: inline-block; width: 10px; height: 10px; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div>
            <h1>IEEE 9-Bus System</h1>
            <p style="color:var(--text-muted); font-size: 0.8rem;">Interactive Analysis Dashboard</p>
        </div>

        <div class="status-card" id="info-card">
            <h2 id="element-name">Select an Element</h2>
            <div id="element-data">
                <p style="color:var(--text-muted)">Hover over buses or lines to view real-time steady-state parameters.</p>
            </div>
        </div>

        <div class="status-card" style="border-left-color: var(--accent-blue);">
            <h2>System Status</h2>
            <div class="data-row"><span class="data-label">Frequency:</span> <span class="data-val">50.00 Hz</span></div>
            <div class="data-row"><span class="data-label">Status:</span> <span class="data-val" id="sys-status">Steady State</span></div>
            <div class="data-row"><span class="data-label">Solver:</span> <span class="data-val" id="solver-type">Newton-Raphson</span></div>
        </div>

        <div class="control-group">
            <h2>Fault Simulation</h2>
            <label style="font-size: 0.8rem; color: var(--text-muted);">Target Transmission Line:</label>
            <select id="fault-selector">
                <option value="" disabled selected>Select Line...</option>
                <option value="line_4_5">Line 4-5</option>
                <option value="line_4_6">Line 4-6</option>
                <option value="line_5_7">Line 5-7</option>
                <option value="line_6_9">Line 6-9</option>
                <option value="line_7_8">Line 7-8</option>
                <option value="line_8_9">Line 8-9</option>
            </select>
            <button onclick="toggleFault()" id="sim-btn">SIMULATE FAULT</button>
            <p id="sim-status" style="font-size: 0.8rem; text-align: center; color: var(--text-muted); margin-top: 10px;"></p>
        </div>
    </div>

    <div id="diagram-container">
        <svg viewBox="0 0 800 600" id="sld-svg">
            
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                  <path d="M0,0 L0,6 L9,3 z" fill="#8d99ae" />
                </marker>
            </defs>

            <path id="tf_7_2" d="M200,100 L100,100" class="line-path" />
            
            <path id="tf_9_3" d="M600,100 L700,100" class="line-path" />
            
            <path id="tf_4_1" d="M250,500 L150,500" class="line-path" />

            <path id="line_7_8" d="M200,100 L400,100" class="line-path" />
            
            <path id="line_8_9" d="M400,100 L600,100" class="line-path" />
            
            <path id="line_5_7" d="M200,350 L200,100" class="line-path" />
            
            <path id="line_6_9" d="M600,350 L600,100" class="line-path" />
            
            <path id="line_4_5" d="M250,500 L200,350" class="line-path" />
            
            <path id="line_4_6" d="M250,500 L600,350" class="line-path" />


            <path id="g1_b1" d="M150,500 L100, 500" class="line-path" />
            <path id="g2_b2" d="M50,100 L100,100" class="line-path" />
            <path id="g3_b3" d="M700,100 L750,100" class="line-path" />


            <g id="gen_2" transform="translate(60, 100)">
                <circle cx="0" cy="0" r="20" class="component-shape" />
                <text x="-5" y="6" font-size="16" fill="white">~</text>
                <text x="-35" y="50" class="label-text">G2 (163MW)</text>
            </g>
            <g id="gen_3" transform="translate(740, 100)">
                <circle cx="0" cy="0" r="20" class="component-shape" />
                <text x="-5" y="5" font-size="16" fill="white">~</text>
                <text x="-30" y="50" class="label-text">G3 (85MW)</text>
            </g>
            <g id="gen_1" transform="translate(110, 500)">
                <circle cx="0" cy="0" r="20" class="component-shape" />
                <text x="-5" y="5" font-size="16" fill="white">~</text>
                <text x="-30" y="50" class="label-text">G1 (Swing)</text>
            </g>

            <line id="bus_2" x1="100" y1="80" x2="100" y2="120" class="bus-bar" /> 
            <text x="90" y="70" class="label-text">Bus 2</text>

            <line id="bus_7" x1="200" y1="80" x2="200" y2="120" class="bus-bar" /> 
            <text x="190" y="70" class="label-text">Bus 7</text>

            <line id="bus_8" x1="400" y1="80" x2="400" y2="120" class="bus-bar" />
            <text x="390" y="70" class="label-text">Bus 8</text>

            <line id="bus_9" x1="600" y1="80" x2="600" y2="120" class="bus-bar" />
            <text x="590" y="70" class="label-text">Bus 9</text>

            <line id="bus_3" x1="700" y1="80" x2="700" y2="120" class="bus-bar" />
            <text x="690" y="70" class="label-text">Bus 3</text>

            <line id="bus_5" x1="180" y1="350" x2="220" y2="350" class="bus-bar" />
            <text x="150" y="340" class="label-text">Bus 5</text>

            <line id="bus_6" x1="580" y1="350" x2="620" y2="350" class="bus-bar" />
            <text x="630" y="340" class="label-text">Bus 6</text>

            <line id="bus_4" x1="250" y1="480" x2="250" y2="520" class="bus-bar" />
            <text x="260" y="530" class="label-text">Bus 4</text>

            <line id="bus_1" x1="150" y1="480" x2="150" y2="520" class="bus-bar" />
            <text x="140" y="470" class="label-text">Bus 1</text>

            <g transform="translate(150, 100)"> <circle cx="0" cy="0" r="10" stroke="white" fill="#1e1e24" />
                <circle cx="10" cy="0" r="10" stroke="white" fill="#1e1e24" />
            </g>
            <g transform="translate(650, 100)"> <circle cx="0" cy="0" r="10" stroke="white" fill="#1e1e24" />
                <circle cx="10" cy="0" r="10" stroke="white" fill="#1e1e24" />
            </g>
            <g transform="translate(200, 500)"> <circle cx="0" cy="0" r="10" stroke="white" fill="#1e1e24" />
                <circle cx="10" cy="0" r="10" stroke="white" fill="#1e1e24" />
            </g>

            <path d="M200,350 L200,400 L190,390 M200,400 L210,390" stroke="#a8dadc" fill="none" stroke-width="2"/>
            <text x="190" y="420" class="label-text">Load A</text>

            <path d="M600,350 L600,400 L590,390 M600,400 L610,390" stroke="#a8dadc" fill="none" stroke-width="2"/>
            <text x="590" y="420" class="label-text">Load B</text>

            <path d="M400,120 L400,170 L390,160 M400,170 L410,160" stroke="#a8dadc" fill="none" stroke-width="2"/>
            <text x="380" y="190" class="label-text">Load C</text>

        </svg>

        <div class="legend">
            <span style="background:var(--bus-color)"></span>Bus
            <span style="background:var(--line-normal)"></span>Line/TF
            <span style="background:var(--accent-red)"></span>Fault
        </div>
    </div>

    <script>
        let systemData = { buses: {}, lines: {} };
        let isFaultActive = false;
        let updateInterval = null;

        const infoCardName = document.getElementById("element-name");
        const infoCardData = document.getElementById("element-data");

        function createRow(label, value, unit) {
            return `<div class="data-row"><span class="data-label">${label}</span> <span class="data-val">${value} ${unit}</span></div>`;
        }

        async function fetchSystemState(payload = { type: 'loadflow' }) {
            try {
                const res = await fetch('http://127.0.0.1:5000/api/solve', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                systemData = data;
            } catch (err) { console.error("API Error", err); }
        }

        // --- HOVER LOGIC ---
        document.querySelectorAll('.bus-bar, .line-path').forEach(el => {
            el.addEventListener('mouseenter', (e) => {
                const id = e.target.id;
                e.target.style.stroke = "white";

                if (id.includes("bus")) {
                    const data = systemData.buses[id];
                    if (data) {
                        infoCardName.textContent = data.name;
                        document.getElementById("info-card").style.borderLeftColor = "#fca311";
                        let html = createRow("Voltage (pu):", data.pu.toFixed(4), "pu");
                        html += createRow("Voltage (kV):", data.kv.toFixed(2), "kV");
                        html += createRow("Phase:", data.angle.toFixed(2), "deg");
                        html += createRow("Active P:", data.p.toFixed(2), "MW");
                        html += createRow("Reactive Q:", data.q.toFixed(2), "MVar");
                        infoCardData.innerHTML = html;
                    }
                } else if (id.includes("line") || id.includes("tf")) {
                    const data = systemData.lines[id];
                    if (data) {
                        infoCardName.textContent = data.name;
                        document.getElementById("info-card").style.borderLeftColor = "#4cc9f0";
                        let html = createRow("From:", data.from, "");
                        html += createRow("To:", data.to, "");
                        html += createRow("Active P:", data.mw.toFixed(2), "MW");
                        html += createRow("Reactive Q:", data.mvar.toFixed(2), "MVar");
                        html += createRow("Apparent S:", data.mva.toFixed(2), "MVA");
                        infoCardData.innerHTML = html;
                    }
                }
            });

            el.addEventListener('mouseleave', (e) => {
                e.target.style.stroke = ""; 
            });
        });

        // --- FAULT TOGGLE LOGIC ---
        async function toggleFault() {
            const btn = document.getElementById("sim-btn");
            const statusText = document.getElementById("sim-status");
            const sysStatus = document.getElementById("sys-status");
            const solverLabel = document.getElementById("solver-type");
            const lineId = document.getElementById("fault-selector").value;
            const lineEl = document.getElementById(lineId);

            btn.disabled = true;

            if (!isFaultActive) {
                // --- SIMULATE FAULT ---
                if(!lineId) { btn.disabled=false; return alert("Select a line first!"); }

                // Stop auto-refresh so we don't overwrite fault data
                if (updateInterval) clearInterval(updateInterval);

                btn.textContent = "Calculating...";
                statusText.textContent = "Solving Differential Equations...";
                
                if(lineEl) lineEl.classList.add('fault-flash');

                // Call Backend (Fault)
                await fetchSystemState({ type: 'fault', line_id: lineId });

                // Update UI to "Faulted" state
                isFaultActive = true;
                btn.textContent = "CLEAR FAULT";
                btn.classList.add("btn-clear"); // Turn Green
                statusText.textContent = "Fault Active (t=0.1s)";
                sysStatus.textContent = "Transient / Faulted";
                sysStatus.style.color = "#e63946";
                solverLabel.textContent = "Mod. Euler (Transient)";
                
                btn.disabled = false;

            } else {
                // --- CLEAR FAULT ---
                btn.textContent = "Clearing...";
                statusText.textContent = "Restoring Steady State...";
                
                if(lineEl) lineEl.classList.remove('fault-flash');

                // Call Backend (Normal Loadflow)
                await fetchSystemState({ type: 'loadflow' });

                // Update UI to "Stable" state
                isFaultActive = false;
                btn.textContent = "SIMULATE FAULT";
                btn.classList.remove("btn-clear"); // Turn Red
                statusText.textContent = "System Stable";
                sysStatus.textContent = "Steady State";
                sysStatus.style.color = "#2a9d8f";
                solverLabel.textContent = "Newton-Raphson";

                // Restart Auto-refresh
                updateInterval = setInterval(() => fetchSystemState({ type: 'loadflow' }), 5000);
                
                btn.disabled = false;
            }
        }

        // Initial Start
        fetchSystemState({ type: 'loadflow' });
        updateInterval = setInterval(() => fetchSystemState({ type: 'loadflow' }), 5000);

    </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power System | Interactive Analysis</title>
    <style>
        :root {
            --bg-color: #1e1e24;
            --panel-bg: #2b2b36;
            --accent-blue: #00ffff;
            --accent-green: #00ff00d4;
            --accent-red: #ff0000;
            --text-main: #ffffff;
            --text-muted: #8d99ae;
            --line-normal: #a8dadc;
            --bus-color: #ffff00;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 350px;
            background-color: var(--panel-bg);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
        }

        h1 { font-size: 1.4rem; margin: 0; color: var(--accent-blue); }
        h2 { font-size: 1.1rem; border-bottom: 1px solid var(--text-muted); padding-bottom: 5px; margin-top: 0; }
        
        .status-card {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--text-muted);
        }

        .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .data-label { color: var(--text-muted); }
        .data-val { font-weight: bold; font-family: 'Courier New', monospace; }

        .control-group { margin-top: auto; }
        select {
            width: 100%;
            padding: 10px;
            background: var(--bg-color);
            color: var(--text-main);
            border: 1px solid var(--text-muted);
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-red);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { filter: brightness(1.1); }
        button:disabled { background-color: var(--text-muted); cursor: not-allowed; }
        
        button.btn-clear { background-color: var(--accent-green); }

        #diagram-container {
            flex-grow: 1;
            position: relative;
            overflow: auto; 
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: radial-gradient(var(--panel-bg) 1px, transparent 1px);
            background-size: 20px 20px; 
        }

        svg { width: 90%; height: 90%; max-width: 1200px; }

        .line-path { stroke: var(--line-normal); stroke-width: 3; fill: none; transition: stroke 0.3s, stroke-width 0.3s; cursor: pointer; }
        .line-path:hover, .line-path.active { stroke: var(--accent-blue); stroke-width: 5; }
        
        .bus-bar { stroke: var(--bus-color); stroke-width: 6; cursor: pointer; transition: stroke 0.2s; }
        .bus-bar:hover, .bus-bar.active { stroke: #fff; }

        .component-shape { fill: var(--bg-color); stroke: var(--text-main); stroke-width: 2; }
        .label-text { fill: var(--text-muted); font-size: 12px; font-family: sans-serif; pointer-events: none; }

        .fault-flash { animation: flash 0.5s infinite; stroke: var(--accent-red) !important; }
        @keyframes flash { 0% { stroke-opacity: 1; } 50% { stroke-opacity: 0.2; } 100% { stroke-opacity: 1; } }

        .legend { position: absolute; bottom: 20px; right: 20px; background: var(--panel-bg); padding: 10px; border-radius: 5px; font-size: 0.8rem; color: var(--text-muted); }
        .legend span { display: inline-block; width: 10px; height: 10px; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div>
            <h1>IEEE 9-Bus System</h1>
            <p style="color:var(--text-muted); font-size: 0.8rem;">Interactive Analysis Dashboard</p>
        </div>

        <div class="status-card" id="info-card">
            <h2 id="element-name">Select an Element</h2>
            <div id="element-data">
                <p style="color:var(--text-muted)">Hover over buses or lines to view real-time steady-state parameters.</p>
            </div>
        </div>

        <div class="status-card" id="system-status-card" style="border-left-color: #00ff00;">
            <h2>System Status</h2>
            <div class="data-row">
                <span class="data-label">Frequency:</span>
                <span class="data-val" id="sys-frequency">50.00 Hz</span>
            </div>
            <div class="data-row">
                <span class="data-label">Status:</span>
                <span class="data-val" id="sys-status" style="color: #00ff00;">Steady State</span>
            </div>
            <div class="data-row">
                <span class="data-label">Solver:</span>
                <span class="data-val" id="solver-type">Newton-Raphson</span>
            </div>
        </div>

        <div class="control-group">
            <h2>Fault Simulation</h2>
            <label style="font-size: 0.8rem; color: var(--text-muted);">Target Transmission Line:</label>
            <select id="fault-selector">
                <option value="" disabled selected>Select Line...</option>
                <option value="line_4_5">Line 4-5</option>
                <option value="line_4_6">Line 4-6</option>
                <option value="line_5_7">Line 5-7</option>
                <option value="line_6_9">Line 6-9</option>
                <option value="line_7_8">Line 7-8</option>
                <option value="line_8_9">Line 8-9</option>
            </select>
            <button onclick="toggleFault()" id="sim-btn">SIMULATE FAULT</button>
            <p id="sim-status" style="font-size: 0.8rem; text-align: center; color: var(--text-muted); margin-top: 10px;"></p>
        </div>
    </div>

    <div id="diagram-container">
        <svg viewBox="0 0 800 600" id="sld-svg">
            
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                  <path d="M0,0 L0,6 L9,3 z" fill="#8d99ae" />
                </marker>
            </defs>

            <path id="tf_7_2" d="M200,100 L100,100" class="line-path" />
            
            <path id="tf_9_3" d="M600,100 L700,100" class="line-path" />
            
            <path id="tf_4_1" d="M250,500 L150,500" class="line-path" />

            <path id="line_7_8" d="M200,100 L400,100" class="line-path" />
            
            <path id="line_8_9" d="M400,100 L600,100" class="line-path" />
            
            <path id="line_5_7" d="M200,350 L200,100" class="line-path" />
            
            <path id="line_6_9" d="M600,350 L600,100" class="line-path" />
            
            <path id="line_4_5" d="M250,500 L200,350" class="line-path" />
            
            <path id="line_4_6" d="M250,500 L600,350" class="line-path" />


            <path id="g1_b1" d="M150,500 L100, 500" class="line-path" />
            <path id="g2_b2" d="M50,100 L100,100" class="line-path" />
            <path id="g3_b3" d="M700,100 L750,100" class="line-path" />


            <g id="gen_2" transform="translate(60, 100)">
                <circle cx="0" cy="0" r="20" class="component-shape" />
                <text x="-5" y="6" font-size="16" fill="white">~</text>
                <text x="-35" y="50" class="label-text">G2 (163MW)</text>
            </g>
            <g id="gen_3" transform="translate(740, 100)">
                <circle cx="0" cy="0" r="20" class="component-shape" />
                <text x="-5" y="5" font-size="16" fill="white">~</text>
                <text x="-30" y="50" class="label-text">G3 (85MW)</text>
            </g>
            <g id="gen_1" transform="translate(110, 500)">
                <circle cx="0" cy="0" r="20" class="component-shape" />
                <text x="-5" y="5" font-size="16" fill="white">~</text>
                <text x="-30" y="50" class="label-text">G1 (Swing)</text>
            </g>

            <line id="bus_2" x1="100" y1="80" x2="100" y2="120" class="bus-bar" /> 
            <text x="90" y="70" class="label-text">Bus 2</text>

            <line id="bus_7" x1="200" y1="80" x2="200" y2="120" class="bus-bar" /> 
            <text x="190" y="70" class="label-text">Bus 7</text>

            <line id="bus_8" x1="400" y1="80" x2="400" y2="120" class="bus-bar" />
            <text x="390" y="70" class="label-text">Bus 8</text>

            <line id="bus_9" x1="600" y1="80" x2="600" y2="120" class="bus-bar" />
            <text x="590" y="70" class="label-text">Bus 9</text>

            <line id="bus_3" x1="700" y1="80" x2="700" y2="120" class="bus-bar" />
            <text x="690" y="70" class="label-text">Bus 3</text>

            <line id="bus_5" x1="180" y1="350" x2="220" y2="350" class="bus-bar" />
            <text x="150" y="340" class="label-text">Bus 5</text>

            <line id="bus_6" x1="580" y1="350" x2="620" y2="350" class="bus-bar" />
            <text x="630" y="340" class="label-text">Bus 6</text>

            <line id="bus_4" x1="250" y1="480" x2="250" y2="520" class="bus-bar" />
            <text x="260" y="530" class="label-text">Bus 4</text>

            <line id="bus_1" x1="150" y1="480" x2="150" y2="520" class="bus-bar" />
            <text x="140" y="470" class="label-text">Bus 1</text>

            <g transform="translate(150, 100)"> <circle cx="0" cy="0" r="10" stroke="white" fill="#1e1e24" />
                <circle cx="10" cy="0" r="10" stroke="white" fill="#1e1e24" />
            </g>
            <g transform="translate(650, 100)"> <circle cx="0" cy="0" r="10" stroke="white" fill="#1e1e24" />
                <circle cx="10" cy="0" r="10" stroke="white" fill="#1e1e24" />
            </g>
            <g transform="translate(200, 500)"> <circle cx="0" cy="0" r="10" stroke="white" fill="#1e1e24" />
                <circle cx="10" cy="0" r="10" stroke="white" fill="#1e1e24" />
            </g>

            <path d="M200,350 L200,400 L190,390 M200,400 L210,390" stroke="#a8dadc" fill="none" stroke-width="2"/>
            <text x="190" y="420" class="label-text">Load A</text>

            <path d="M600,350 L600,400 L590,390 M600,400 L610,390" stroke="#a8dadc" fill="none" stroke-width="2"/>
            <text x="590" y="420" class="label-text">Load B</text>

            <path d="M400,120 L400,170 L390,160 M400,170 L410,160" stroke="#a8dadc" fill="none" stroke-width="2"/>
            <text x="380" y="190" class="label-text">Load C</text>

        </svg>

        <div class="legend">
            <span style="background:var(--bus-color)"></span>Bus
            <span style="background:var(--line-normal)"></span>Line/TF
            <span style="background:var(--accent-red)"></span>Fault
        </div>
    </div>

    <script>
        let systemData = { buses: {}, lines: {} };
        let isFaultActive = false;
        let updateInterval = null;

        const infoCardName = document.getElementById("element-name");
        const infoCardData = document.getElementById("element-data");

        function createRow(label, value, unit) {
            return `<div class="data-row"><span class="data-label">${label}</span> <span class="data-val">${value} ${unit}</span></div>`;
        }

        async function fetchSystemState(payload = { type: 'loadflow' }) {
            try {
                const res = await fetch('http://127.0.0.1:5000/api/solve', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                systemData = data;
            } catch (err) { console.error("API Error", err); }
        }

        // --- HOVER LOGIC ---
        document.querySelectorAll('.bus-bar, .line-path').forEach(el => {
            el.addEventListener('mouseenter', (e) => {
                const id = e.target.id;
                e.target.style.stroke = "white";

                if (id.includes("bus")) {
                    const data = systemData.buses[id];
                    if (data) {
                        infoCardName.textContent = data.name;
                        document.getElementById("info-card").style.borderLeftColor = "#fca311";
                        let html = createRow("Voltage (pu):", data.pu.toFixed(4), "pu");
                        html += createRow("Voltage (kV):", data.kv.toFixed(2), "kV");
                        html += createRow("Phase:", data.angle.toFixed(2), "deg");
                        html += createRow("Active P:", data.p.toFixed(2), "MW");
                        html += createRow("Reactive Q:", data.q.toFixed(2), "MVar");
                        infoCardData.innerHTML = html;
                    }
                } else if (id.includes("line") || id.includes("tf")) {
                    const data = systemData.lines[id];
                    if (data) {
                        infoCardName.textContent = data.name;
                        document.getElementById("info-card").style.borderLeftColor = "#4cc9f0";
                        let html = createRow("From:", data.from, "");
                        html += createRow("To:", data.to, "");
                        html += createRow("Active P:", data.mw.toFixed(2), "MW");
                        html += createRow("Reactive Q:", data.mvar.toFixed(2), "MVar");
                        html += createRow("Apparent S:", data.mva.toFixed(2), "MVA");
                        infoCardData.innerHTML = html;
                    }
                }
            });

            el.addEventListener('mouseleave', (e) => {
                e.target.style.stroke = ""; 
            });
        });

        function updateSystemStatus(status) {
    const card = document.getElementById("system-status-card");
    const statusText = document.getElementById("sys-status");

    statusText.textContent = status;

    if (status === "Steady State") {
        card.style.borderLeftColor = "var(--accent-green)";
    } else {
        card.style.borderLeftColor = "var(--accent-red)";
    }
}

        // --- FAULT TOGGLE LOGIC ---
        async function toggleFault() {
            const btn = document.getElementById("sim-btn");
            const statusText = document.getElementById("sim-status");
            const sysStatus = document.getElementById("sys-status");
            const solverLabel = document.getElementById("solver-type");
            const lineId = document.getElementById("fault-selector").value;
            const lineEl = document.getElementById(lineId);

            btn.disabled = true;

            if (!isFaultActive) {
                // --- SIMULATE FAULT ---
                if(!lineId) { btn.disabled=false; return alert("Select a line first!"); }

                // Stop auto-refresh so we don't overwrite fault data
                if (updateInterval) clearInterval(updateInterval);

                btn.textContent = "Calculating...";
                statusText.textContent = "Solving Differential Equations...";
                
                if(lineEl) lineEl.classList.add('fault-flash');

                // Call Backend (Fault)
                await fetchSystemState({ type: 'fault', line_id: lineId });

                // Update UI to "Faulted" state
                isFaultActive = true;
                btn.textContent = "CLEAR FAULT";
                btn.classList.add("btn-clear"); // Turn Green
                statusText.textContent = "Fault Active (t=0.1s)";
                updateSystemStatus("Transient / Faulted");
                solverLabel.textContent = "Mod. Euler (Transient)";
                sysStatus.style.color = "#ff0000";
                
                btn.disabled = false;

            } else {
                // --- CLEAR FAULT ---
                btn.textContent = "Clearing...";
                statusText.textContent = "Restoring Steady State...";
                
                if(lineEl) lineEl.classList.remove('fault-flash');

                // Call Backend (Normal Loadflow)
                await fetchSystemState({ type: 'loadflow' });

                // Update UI to "Stable" state
                isFaultActive = false;
                btn.textContent = "SIMULATE FAULT";
                btn.classList.remove("btn-clear"); // Turn Red
                statusText.textContent = "System Stable";
                updateSystemStatus("Steady State");
                solverLabel.textContent = "Newton-Raphson";
                sysStatus.style.color = "#00ff00";

                // Restart Auto-refresh
                updateInterval = setInterval(() => fetchSystemState({ type: 'loadflow' }), 5000);
                
                btn.disabled = false;
            }
        }

        // Initial Start
        fetchSystemState({ type: 'loadflow' });
        updateInterval = setInterval(() => fetchSystemState({ type: 'loadflow' }), 5000);

    </script>
</body>
</html>