<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IEEE 9-Bus System | Interactive Analysis</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== ORIGINAL STYLES (UNCHANGED) ===== */
:root {
    --bg-color: #1e1e24;
    --panel-bg: #2b2b36;
    --accent-blue: #00ffff;
    --accent-green: #00ff00d4;
    --accent-red: #ff0000;
    --text-main: #ffffff;
    --text-muted: #8d99ae;
    --line-normal: #a8dadc;
    --bus-color: #ffff00;
}

body {
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-main);
    margin: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

#sidebar {
    width: 350px;
    background-color: var(--panel-bg);
    padding: 20px;
    box-shadow: 2px 0 10px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    gap: 20px;
    z-index: 10;
}

h1 { font-size: 1.4rem; margin: 0; color: var(--accent-blue); }
h2 { font-size: 1.1rem; border-bottom: 1px solid var(--text-muted); padding-bottom: 5px; margin-top: 0; }

.status-card {
    background: rgba(0,0,0,0.2);
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid var(--text-muted);
}

.data-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.9rem;
}
.data-label { color: var(--text-muted); }
.data-val { font-weight: bold; font-family: 'Courier New', monospace; }

.control-group { margin-top: auto; }

select, button, input[type=range] {
    width: 100%;
    padding: 10px;
    background: var(--bg-color);
    color: var(--text-main);
    border: 1px solid var(--text-muted);
    border-radius: 4px;
}

button {
    cursor: pointer;
    font-weight: bold;
}
button.btn-clear { background-color: var(--accent-green); }

#diagram-container {
    flex-grow: 1;
    position: relative;
    overflow: auto;
    display: flex;
    justify-content: center;
    align-items: center;
}

svg { width: 90%; height: 90%; max-width: 1200px; }

.line-path { stroke: var(--line-normal); stroke-width: 3; fill: none; cursor: pointer; }
.bus-bar { stroke: var(--bus-color); stroke-width: 6; cursor: pointer; }

.fault-flash {
    animation: flash 0.5s infinite;
    stroke: var(--accent-red) !important;
}
@keyframes flash {
    0% { stroke-opacity: 1; }
    50% { stroke-opacity: 0.2; }
    100% { stroke-opacity: 1; }
}

/* ===== NEW: FLOATING PLOT PANEL ===== */
#plot-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 420px;
    background: #111;
    border-radius: 6px;
    padding: 10px;
    display: none;
}
</style>
</head>

<body>

<!-- ===== SIDEBAR ===== -->
<div id="sidebar">
    <div>
        <h1>IEEE 9-Bus System</h1>
        <p style="color:var(--text-muted); font-size:0.8rem;">Interactive Analysis Dashboard</p>
    </div>

    <div class="status-card" id="info-card">
        <h2 id="element-name">Select an Element</h2>
        <div id="element-data">
            <p style="color:var(--text-muted)">Hover over buses or lines</p>
        </div>
    </div>

    <div class="status-card" id="system-status-card">
        <h2>System Status</h2>
        <div class="data-row"><span class="data-label">Status:</span><span class="data-val" id="sys-status">Steady State</span></div>
        <div class="data-row"><span class="data-label">Solver:</span><span class="data-val" id="solver-type">Newton-Raphson</span></div>
    </div>

    <!-- ===== FAULT CONTROL (ORIGINAL) ===== -->
    <div class="control-group">
        <h2>Fault Simulation</h2>
        <select id="fault-selector">
            <option value="" disabled selected>Select Line...</option>
            <option value="line_4_5">Line 4-5</option>
            <option value="line_4_6">Line 4-6</option>
            <option value="line_5_7">Line 5-7</option>
            <option value="line_6_9">Line 6-9</option>
        </select>
        <button onclick="toggleFault()" id="sim-btn">SIMULATE FAULT</button>
    </div>

    <!-- ===== NEW: GENERATOR TRIP ===== -->
    <div class="control-group">
        <h2>Generator Trip</h2>
        <select id="gen-selector">
            <option value="gen_1">G1</option>
            <option value="gen_2">G2</option>
            <option value="gen_3">G3</option>
        </select>
        <button onclick="tripGenerator()">TRIP GENERATOR</button>
    </div>

    <!-- ===== NEW: LOAD SHEDDING ===== -->
    <div class="control-group">
        <h2>Load Shedding</h2>
        <label>Load A</label>
        <input type="range" min="50" max="120" value="100" oninput="adjustLoad('load_A',this.value)">
        <label>Load B</label>
        <input type="range" min="50" max="120" value="100" oninput="adjustLoad('load_B',this.value)">
    </div>
</div>

<!-- ===== MAIN DIAGRAM (SVG UNCHANGED â€“ OMITTED HERE FOR BREVITY) ===== -->
<div id="diagram-container">
    <!-- KEEP YOUR ORIGINAL SVG HERE EXACTLY -->
    <div id="plot-panel">
        <canvas id="freqPlot"></canvas>
    </div>
</div>

<script>
let systemData = {};
let freqChart = null;
let faultActive = false;

function createRow(label, value, unit="") {
    return `<div class="data-row"><span class="data-label">${label}</span><span class="data-val">${value} ${unit}</span></div>`;
}

async function fetchSystem(payload) {
    const res = await fetch("http://127.0.0.1:5000/api/solve", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
    });
    const data = await res.json();
    systemData = data;

    if (data.history) plotFrequency(data.history);
}

function plotFrequency(history) {
    document.getElementById("plot-panel").style.display = "block";
    const ctx = document.getElementById("freqPlot").getContext("2d");
    if (freqChart) freqChart.destroy();

    freqChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: history.time,
            datasets: Object.keys(history.freq).map(g => ({
                label: g,
                data: history.freq[g],
                borderWidth: 2
            }))
        }
    });
}

function toggleFault() {
    const line = document.getElementById("fault-selector").value;
    if (!faultActive) {
        fetchSystem({type:"fault", line_id:line});
        faultActive = true;
        document.getElementById("solver-type").textContent = "Transient";
    } else {
        fetchSystem({type:"postfault"});
        faultActive = false;
        document.getElementById("solver-type").textContent = "Newton-Raphson";
    }
}

function tripGenerator() {
    fetchSystem({
        type:"gen_trip",
        gen_id: document.getElementById("gen-selector").value
    });
}

function adjustLoad(load, val) {
    fetchSystem({
        type:"load_adjust",
        load_id: load,
        scale: val/100
    });
}

fetchSystem({type:"loadflow"});
</script>

</body>
</html>
